#!/usr/bin/env bash

set -euo pipefail

# Figure out LIB_DIR
if [[ -n "${WORKCLI_LIBEXEC:-}" && -d "$WORKCLI_LIBEXEC" ]]; then
    # Running from Homebrew-installed version
    LIB_DIR="$WORKCLI_LIBEXEC"
else
    # Running locally from repo
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
    LIB_DIR="$PROJECT_ROOT/lib"
fi
# ensure lib dir exist
if [ ! -d "$LIB_DIR" ]; then
    echo "Library directory '$LIB_DIR' does not exist."
    exit 1
fi

# Source core + command files
# shellcheck disable=SC1091
source "$LIB_DIR/core.sh"
# shellcheck disable=SC1091
source "$LIB_DIR/commands-init.sh"
# shellcheck disable=SC1091
source "$LIB_DIR/commands-create.sh"
# shellcheck disable=SC1091
source "$LIB_DIR/commands-finish.sh"
# shellcheck disable=SC1091
source "$LIB_DIR/commands-status.sh"
# shellcheck disable=SC1091
source "$LIB_DIR/commands-start.sh"

# Command routing
COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
  init)   cmd_init "$@" ;;
  create)  cmd_create "$@" ;;
  finish)  cmd_finish "$@" ;;
  start)   cmd_start "$@" ;;
  status|--status|-st)  cmd_status "$@" ;;
  help|--help|-h) cmd_help ;;
  --version) cmd_version ;;
  *) echo "Unknown command: $COMMAND" && cmd_help && exit 1 ;;
esac
